<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>{{ title }} - H·ªçc To√°n C√πng Doraemon</title>
    <link rel="stylesheet" href="/static/css/style.css"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* === C·∫§U TR√öC & GIAO DI·ªÜN === */
        :root {
            --dora-blue: #0096E2;
            --dora-red: #E60033;
            --dora-yellow: #F0C420;
            --bg-soft: #F4F7FE;
            --card-shadow: 0 20px 40px rgba(0, 150, 226, 0.1);
        }

        body {
            background-color: var(--bg-soft);
            font-family: 'Nunito', sans-serif;
            margin: 0; padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Header ti√™u ƒë·ªÅ */
        .page-title-box {
            text-align: center;
            margin-bottom: 30px;
        }
        .page-title-box h2 {
            display: inline-block;
            margin: 0;
            padding: 15px 50px;
            background: white;
            color: var(--dora-blue);
            font-weight: 900;
            font-size: 1.8rem;
            border-radius: 60px;
            box-shadow: var(--card-shadow);
            position: relative;
        }
        .page-title-box h2::after {
            content: 'üîî'; position: absolute; right: 20px; animation: ring 2s infinite ease-in-out;
        }
        @keyframes ring { 0%, 100% { transform: rotate(0); } 10%, 30% { transform: rotate(15deg); } 20% { transform: rotate(-15deg); } }

        /* === B·ªê C·ª§C L∆Ø·ªöI (GRID) === */
        .stats-grid-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px; 
            margin-bottom: 40px;
        }

        .grid-item-half { grid-column: span 1; }
        .grid-item-full { grid-column: span 2; }

        /* === TH·∫∫ CARD (SOFT UI) === */
        .glass-card {
            background: white;
            border-radius: 24px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
            overflow: hidden;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 150, 226, 0.2);
        }

        .accent-red { border-top: 5px solid var(--dora-red); }
        .accent-yellow { border-top: 5px solid var(--dora-yellow); }
        .accent-blue { border-top: 5px solid var(--dora-blue); }

        .card-title {
            text-align: center;
            font-weight: 800;
            color: #444;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .chart-tall-wrapper {
            min-height: 400px;
            position: relative;
        }

        /* === KHU V·ª∞C AI (ƒê√É CH·ªàNH L√äN TR√äN) === */
        .ai-interaction-zone {
            background: #FFF9C4; /* N·ªÅn v√†ng nh·∫°t */
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            border: 3px dashed var(--dora-yellow);
            margin-bottom: 40px; /* Th√™m kho·∫£ng c√°ch v·ªõi l∆∞·ªõi bi·ªÉu ƒë·ªì b√™n d∆∞·ªõi */
        }

        .button-doraemon {
            background: linear-gradient(45deg, var(--dora-blue), #00B4FF);
            border: none;
            padding: 15px 40px;
            color: white;
            font-weight: 900;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 10px 20px -10px rgba(0, 150, 226, 0.5);
            transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 10px;
        }
        .button-doraemon:hover { transform: scale(1.05); box-shadow: 0 15px 30px -10px rgba(0, 150, 226, 0.7); }
        .button-doraemon:active { transform: scale(0.98); }

        .ai-chat-bubble {
            display: flex; align-items: flex-start; gap: 20px;
            background: white; padding: 25px; border-radius: 25px;
            margin-top: 20px; text-align: left;
            box-shadow: var(--card-shadow);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {opacity: 0; transform: scale(0.9);} to {opacity: 1; transform: scale(1);} }

        .ai-avatar { width: 70px; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1)); }
        .ai-content { flex: 1; font-size: 1.05rem; line-height: 1.6; color: #333; }
        .typing-dots span { display: inline-block; width: 8px; height: 8px; background: var(--dora-blue); border-radius: 50%; margin-right: 5px; animation: wave 1.3s infinite; }
        @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }

        @media (max-width: 768px) {
            .stats-grid-container { grid-template-columns: 1fr; }
            .grid-item-full { grid-column: span 1; }
            .chart-tall-wrapper { min-height: 300px; }
        }
        
        .no-stats-box { text-align: center; padding: 50px; background: white; border-radius: 24px; box-shadow: var(--card-shadow); }
    </style>
</head>
<body>
    {% include '_header.html' %} 
    
    <main class="container">
        <div class="page-title-box">
            <h2>Th·ªëng K√™ C·ªßa B√©: {{ current_user.username }}</h2>
        </div>
        
        {% if chart_data_avg %} 
            
            <section class="ai-interaction-zone">
                <button id="generate-report-btn" class="button-doraemon">
                    <span>‚ú®</span> Nh·ªù Doraemon Ph√¢n T√≠ch K·∫øt Qu·∫£ <span>‚ú®</span>
                </button>
                
                <div id="ai-report-container" class="ai-chat-bubble" style="display:none;">
                    <img src="/static/img/doraemon_stand.png" alt="Doraemon" class="ai-avatar">
                    <div class="ai-content">
                        <div class="typing-dots" id="ai-report-loader">
                            <span></span><span></span><span></span> ƒêang suy nghƒ©...
                        </div>
                        <p id="ai-report-text" style="margin: 0; font-weight: 600;"></p>
                    </div>
                </div>
                <div id="data-for-ai" style="display: none;">{{ data_summary_for_ai }}</div>
            </section>

            <div class="stats-grid-container">
                
                <div class="glass-card grid-item-half accent-red">
                    <h4 class="card-title">üéØ ƒêi·ªÉm Trung B√¨nh C√°c Game</h4>
                    <div>
                        <canvas id="scoreChartAvg" height="220"></canvas>
                    </div>
                </div>

                <div class="glass-card grid-item-half accent-yellow">
                    <h4 class="card-title">üçï T·ª∑ L·ªá B√© Ch∆°i Game</h4>
                    <div style="max-width: 70%; margin: 0 auto;">
                        <canvas id="scoreChartPie" height="220"></canvas>
                    </div>
                </div>

                <div class="glass-card grid-item-full accent-blue">
                    <h4 class="card-title" style="font-size: 1.3rem;">üìà Ti·∫øn ƒê·ªô H·ªçc T·∫≠p G·∫ßn ƒê√¢y (Chi Ti·∫øt)</h4>
                    <div class="chart-tall-wrapper">
                        <canvas id="scoreChartLine"></canvas>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="no-stats-box">
                <img src="/static/img/doraemon_stand.png" alt="Nobita bu·ªìn" style="width: 150px; filter: grayscale(0.5);"> 
                <h3 style="color: var(--dora-blue);">Trang gi·∫•y c√≤n tr·∫Øng tinh!</h3>
                <p>B√© ch∆∞a ch∆°i game n√†o c·∫£. H√£y b·∫Øt ƒë·∫ßu h·ªçc ƒë·ªÉ Doraemon ghi l·∫°i th√†nh t√≠ch nh√©!</p>
                <a href="{{ url_for('learning') }}" class="button-doraemon" style="text-decoration: none; margin-top: 20px;">H·ªçc B√†i Ngay!</a>
            </div>
        {% endif %}
    </main>

    {% include '_footer.html' %}
    {% include '_header_fake.html' %} 

    <script>
        // === GI·ªÆ NGUY√äN LOGIC SCRIPT C≈® ===
        const chartDataAvg = {{ chart_data_avg | tojson }};
        const chartDataLine = {{ chart_data_line | tojson }};
        const chartDataPie = {{ chart_data_pie | tojson }};
        const doraColors = [
            'rgba(0, 158, 227, 0.8)', 'rgba(215, 0, 15, 0.8)',   
            'rgba(253, 203, 8, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'
        ];

        // 1. C·ªôt
        if (chartDataAvg?.labels?.length) {
            new Chart(document.getElementById('scoreChartAvg'), {
                type: 'bar',
                data: {
                    labels: chartDataAvg.labels,
                    datasets: [{ label: 'ƒêi·ªÉm TB', data: chartDataAvg.data, backgroundColor: doraColors, borderRadius: 8 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            });
        }

        // 2. ƒê∆∞·ªùng (Ti·∫øn ƒë·ªô) - ƒê√£ ch·ªânh max: 110
        if (chartDataLine?.labels?.length) {
            new Chart(document.getElementById('scoreChartLine'), {
                type: 'line',
                data: {
                    labels: chartDataLine.labels,
                    datasets: [{
                        label: 'ƒêi·ªÉm s·ªë', data: chartDataLine.data,
                        backgroundColor: 'rgba(0, 158, 227, 0.15)', borderColor: '#0096E2',
                        borderWidth: 4, tension: 0.3, fill: true, pointRadius: 6, pointBackgroundColor: '#fff', pointBorderColor: '#0096E2'
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: true, max: 500 } 
                    }
                }
            });
        }
        
        // 3. Tr√≤n
        if (chartDataPie?.labels?.length) {
            new Chart(document.getElementById('scoreChartPie'), {
                type: 'doughnut',
                data: { labels: chartDataPie.labels, datasets: [{ data: chartDataPie.data, backgroundColor: doraColors, borderWidth: 3 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Logic AI
        const reportBtn = document.getElementById('generate-report-btn');
        const reportContainer = document.getElementById('ai-report-container');
        const reportText = document.getElementById('ai-report-text');
        const reportLoader = document.getElementById('ai-report-loader');
        const dataForAI = document.getElementById('data-for-ai')?.innerText;

        if (reportBtn) {
            reportBtn.addEventListener('click', async () => {
                reportContainer.style.display = 'flex'; reportLoader.style.display = 'block'; reportText.style.display = 'none'; reportBtn.disabled = true;
                try {
                    const response = await fetch('/generate_student_report', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ data: dataForAI }) });
                    const result = await response.json();
                    reportText.innerText = result.report;
                } catch (e) { reportText.innerText = "L·ªói k·∫øt n·ªëi."; } 
                finally { reportLoader.style.display = 'none'; reportText.style.display = 'block'; reportBtn.disabled = false; }
            });
        }
    </script>
</body>
</html>