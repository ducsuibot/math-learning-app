<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Phụ Huynh</title>
    <link rel="stylesheet" href="/static/css/style.css"> 
    <link rel="stylesheet" href="/static/css/profile.css"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head> <body>
    {% include '_header.html' %} 
    
    <main class="container">
        <h2>Xin chào Phụ huynh, {{ current_user.username }}!</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <section class="profile-container">
            <h3>Liên kết với tài khoản của con</h3>
            <p>Nhập tên đăng nhập (username) của tài khoản học sinh để theo dõi.</p>
            <form method="POST" action="{{ url_for('parent_dashboard') }}" class="link-child-form">
                <div class="form-group">
                    <label for="child_username">Tên đăng nhập của con:</label>
                    <input type="text" name="child_username" class="form-control" required>
                </div>
                <button type="submit" class="button-primary">Liên kết</button>
            </form>
        </section>

        {% if children %}
            {% for child in children %}
                <section class="profile-container" style="margin-top: 20px;">
                    <h3>Thống kê của bé: {{ child.username }}</h3>
                    
                    <h4>Điểm trung bình các game</h4>
                    <div style="width: 90%; margin: auto;">
                        <canvas id="scoreChart"></canvas>
                    </div>

                    <h4 style="margin-top: 30px;">Báo cáo từ Doraemon AI</h4>
                    <button id="generate-report-btn" class="button-primary">Tạo báo cáo thống kê</button>
                    <div id="ai-report-container" style="display:none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 8px; text-align: left;">
                        <p id="ai-report-text">Đang tạo báo cáo...</p>
                    </div>
                    <div id="data-for-ai" style="display: none;">{{ data_summary_for_ai }}</div>
                </section>
            {% endfor %}
        {% else %}
            <section class="profile-container" style="margin-top: 20px; text-align: center;">
                <p>Bạn chưa liên kết với tài khoản học sinh nào.</p>
            </section>
        {% endif %}
    </main>

    {% include '_footer.html' %}

    <script>
        // 1. Script cho Đồ thị Cột
        const chartData = {{ chart_data | tojson }};
        if (chartData && chartData.labels && chartData.labels.length > 0) { // Kiểm tra chartData có rỗng không
            const ctx = document.getElementById('scoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Điểm Trung Bình',
                        data: chartData.data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                        ],
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // 2. Script cho Báo cáo AI
        const reportBtn = document.getElementById('generate-report-btn');
        const reportContainer = document.getElementById('ai-report-container');
        const reportText = document.getElementById('ai-report-text');
        const dataForAI = document.getElementById('data-for-ai').innerText;

        if (reportBtn) {
            reportBtn.addEventListener('click', async () => {
                reportContainer.style.display = 'block';
                reportText.innerText = "Doraemon đang phân tích dữ liệu...";
                reportBtn.disabled = true;

                try {
                    const response = await fetch('/parent/generate_report', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: dataForAI }) // Gửi dữ liệu điểm lên
                    });
                    const result = await response.json();
                    reportText.innerText = result.report;
                } catch (error) {
                    reportText.innerText = "Lỗi: Không thể tạo báo cáo.";
                } finally {
                    reportBtn.disabled = false;
                }
            });
        }
    </script>
    
    <script src="/static/js/script.js"></script> 
</body> </html>